<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="rgb(255,255,255)"><meta http-equiv=x-ua-compatible content="ie=edge"><title>Automatically tagging resources in AWS with Owner Information &#183; /misczak</title><meta name=title content="Automatically tagging resources in AWS with Owner Information &#183; /misczak"><meta name=description content="A detailed write-up on extending an AWS Cloud Operations & Migrations Blog post example for automatically tagging EC2 instances in AWS."><link rel=canonical href=https://misczak.github.io/posts/2023-07-31/><link type=text/css rel=stylesheet href=/css/main.bundle.min.b15bed9c75c13ca3a738d365165ea777e34f367687cb02db8605dcf7786b76165f84c3f19f2c5d126d63d5597fe5ea155750bc6b0d4b822e90a9a8641b628437.css integrity="sha512-sVvtnHXBPKOnONNlFl6nd+NPNnaHywLbhgXc93hrdhZfhMPxnyxdEm1j1Vl/5eoVV1C8aw1Lgi6QqahkG2KENw=="><script type=text/javascript src=/js/appearance.min.1e44157c1e51b46341ce2c94716dd3dd1ef30c28e7d1c9f3b9db80877bfe72bc66b00d8a662f317840016acbed93c5f18c3d9268c8b957021ee74d0b04adf6c5.js integrity="sha512-HkQVfB5RtGNBziyUcW3T3R7zDCjn0cnzuduAh3v+crxmsA2KZi8xeEABasvtk8XxjD2SaMi5VwIe500LBK32xQ=="></script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="Automatically tagging resources in AWS with Owner Information"><meta property="og:description" content="A detailed write-up on extending an AWS Cloud Operations & Migrations Blog post example for automatically tagging EC2 instances in AWS."><meta property="og:type" content="article"><meta property="og:url" content="https://misczak.github.io/posts/2023-07-31/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-07-31T00:00:00+00:00"><meta property="article:modified_time" content="2023-07-31T00:00:00+00:00"><meta property="og:site_name" content="/misczak"><meta name=twitter:card content="summary"><meta name=twitter:title content="Automatically tagging resources in AWS with Owner Information"><meta name=twitter:description content="A detailed write-up on extending an AWS Cloud Operations & Migrations Blog post example for automatically tagging EC2 instances in AWS."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"Automatically tagging resources in AWS with Owner Information","headline":"Automatically tagging resources in AWS with Owner Information","description":"A detailed write-up on extending an AWS Cloud Operations \u0026 Migrations Blog post example for automatically tagging EC2 instances in AWS.","abstract":"Background # One of AWS\u0026rsquo; best practices for building and managing infrastructure in the cloud is to use consistent, accurate tags for the purposes of cost management, correct owner attribution (during operations and security incidents), and even attribute-based access control.","inLanguage":"en","url":"https:\/\/misczak.github.io\/posts\/2023-07-31\/","author":{"@type":"Person","name":"John Misczak"},"copyrightYear":"2023","dateCreated":"2023-07-31T00:00:00\u002b00:00","datePublished":"2023-07-31T00:00:00\u002b00:00","dateModified":"2023-07-31T00:00:00\u002b00:00","keywords":["AWS"],"mainEntityOfPage":"true","wordCount":"2154"}]</script><meta name=author content="John Misczak"><link href=https://github.com/misczak rel=me><link href=https://linkedin.com/in/johnmisczak rel=me><link href=https://infosec.exchange/@misczak rel=me></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold text-neutral-900 dark:text-neutral print:hidden sm:py-10"><nav class="flex items-start justify-between sm:items-center"><div class="flex flex-row items-center"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>/misczak</a></div><ul class="flex list-none flex-col ltr:text-right rtl:text-left sm:flex-row"><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/posts/ title=Posts>Blog</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/about/ title>About</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/categories/ title=Categories>Categories</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/archive/ title=Archive>Archive</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/contact/ title>Contact</a></li></ul></nav></header><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header class=max-w-prose><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Automatically tagging resources in AWS with Owner Information</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2023-07-31 00:00:00 +0000 UTC">July 31 2023</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">11 mins</span></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first px-0 lg:order-last lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-10"><details open class="mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#researching-previous-work>Researching Previous Work</a></li><li><a href=#the-auto-tagging-solution-explained>The Auto Tagging Solution, Explained</a></li><li><a href=#modifying-the-aws-example>Modifying the AWS Example</a></li><li><a href=#applying-the-service-control-policy>Applying the Service Control Policy</a></li><li><a href=#results-and-additional-considerations>Results and Additional Considerations</a></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-prose grow"><h2 id=background class="relative group">Background <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#background aria-label=Anchor>#</a></span></h2><p>One of AWS&rsquo; best practices for building and managing infrastructure in the cloud is to use consistent, accurate tags for the purposes of cost management, correct owner attribution (during operations and security incidents), and even attribute-based access control. This type of tag compliance can be easier said than done, however, especially when dealing with an organization that has a number of accounts owned by different teams with very different tooling and working styles.</p><p>My team has dealt with a number of security incidents over the last year where finding the correct owner of an EC2 instance took too much time, in our eyes, at the beginning of the incident. No tags were added to the instance besides <code>Name</code>, and while CloudTrail would capture the the events that created the resource (and the principal involved), some resources predated our currently retained CloudTrail logs - meaning we did not have a record of the user that created them.</p><p>While it is possible to require tags to be added to resources at the time of creation (otherwise blocking the creation of the resource), my team preferred not to pursue this approach for a few reasons. Implementing that type of compliance check would take a very long time to incorporate into the various workflows across the dozens of accounts for which we have oversight. Moreover, restricting resource creation until somebody enters the correct tag information can make the security team look like blockers instead of team players, which is something we are always looking to avoid.</p><p>For these reasons, I wanted to see what could be done to leverage information AWS has about our resources in order to attach tags about the owner to the instance&rsquo;s metadata itself without, so it would live alongside the instance for the duration of its lifetime. The preferred approach would not require any additional work on behalf of the individual or team creating the resources in the first place, and not interfere with their existing workflows.</p><h2 id=researching-previous-work class="relative group">Researching Previous Work <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#researching-previous-work aria-label=Anchor>#</a></span></h2><p>A lot of times when trying to work on projects such as this one, I end up with the thought process that somebody, somewhere, has to have solved this particular problem before. So I began my research process across the Internet, Reddit, and even the Cloud Security Slack.</p><p>What became immediately apparent is that AWS already has this information available to you; however, it&rsquo;s just not in a format (or part of a service) that makes it easy to extract. There is a tag called <code>aws:createdBy</code> that can be activated in the Billing Console via the management account, <a href=https://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/aws-tags.html target=_blank>after which AWS will apply it to a subset of resources</a>.</p><p>The only issue with this tag is that it is only available in the Billing console and reports - it does not appear alongside other tags for your resources. There are some <a href=https://github.com/wolfeidau/aws-billing-store/ target=_blank>great projects</a> out there that look to make this report information more easily queryable - but they still didn&rsquo;t feel like the right fit for us, as many of the projects pushed the tag information into a separate repository, with tag information about newly created resources susceptible to a delay.</p><p>Finally, I found a <a href=https://aws.amazon.com/blogs/mt/auto-tag-aws-resources/ target=_blank>post from the AWS Cloud Operations & Migrations blog</a> from back in November 2020 that was exactly what I was looking for. It was a solution that used CloudWatch events and a Lambda function to read incoming <code>RunInstances</code> CloudTrail events and use the information from within the event to tag the newly created resource. It even had sample Python code for the Lambda function! There were only one problem with this example that prevented it from being a slam dunk - it was focused on only one account and one region. To make this solution useful in our environment, we would have to extend it to work across all of the accounts in a certain OU, and across all regions.</p><h2 id=the-auto-tagging-solution-explained class="relative group">The Auto Tagging Solution, Explained <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#the-auto-tagging-solution-explained aria-label=Anchor>#</a></span></h2><p>In case you don&rsquo;t want to click through to the AWS blog post itself, I&rsquo;ll briefly explain the solution. When a principal starts an EC2 instance in AWS, a <code>RunInstances</code> event is generated and logged by CloudTrail. These events contain a variety of information, including the time of the event, the principal that triggered it, the account that the instance was created in, and the region that the instance was created in. All of this information is extremely useful to capture.</p><p><a href=images/cloudtrailevent.png><figure><img class="my-0 rounded-md" srcset="/posts/2023-07-31/images/cloudtrailevent_hu30115bbbe8e66407e2a970cbe55134ca_107836_330x0_resize_box_3.png 330w,
/posts/2023-07-31/images/cloudtrailevent_hu30115bbbe8e66407e2a970cbe55134ca_107836_660x0_resize_box_3.png 660w,
/posts/2023-07-31/images/cloudtrailevent_hu30115bbbe8e66407e2a970cbe55134ca_107836_1024x0_resize_box_3.png 1024w,
/posts/2023-07-31/images/cloudtrailevent_hu30115bbbe8e66407e2a970cbe55134ca_107836_1320x0_resize_box_3.png 2x" src=/posts/2023-07-31/images/cloudtrailevent_hu30115bbbe8e66407e2a970cbe55134ca_107836_660x0_resize_box_3.png alt="An example of a CloudTrail event for RunInstances"></figure></a></p><p>A service called AWS EventBridge (formerly CloudWatch Events) allows for rules to be created that can monitor CloudTrail for specific events, and then perform some action based on the event. The auto tagging solution includes a rule that monitors for the <code>RunInstances</code> events, and then sends the information from a captured event to an AWS Lambda function. This Lambda function reads the information in the event (mostly the instance ID and principal information), and then uses that information to apply a tag to the instance with the information about the principal.</p><p>The chief limitation of this solution, as presented in the blog post, is that CloudTrail in a given region will only capture the <code>RunInstances</code> events that happen in that region. Additionally, a Lambda function would only be able to apply tags to instances in the same account as the function itself.</p><h2 id=modifying-the-aws-example class="relative group">Modifying the AWS Example <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#modifying-the-aws-example aria-label=Anchor>#</a></span></h2><p>The first problem - that the example solution only covered a single region - can be solved easily enough. Whereas the example used a single Event Rule, we would have to end up deploying the same rule in every region (of every account) that we planned on supporting as part of this solution. This requirement could be met by running a CloudFormation StackSet that created the rule in each region that each account uses.</p><p>The second problem - that the example focused on just one account - was a little trickier to think about. Event rules can send events to Lambda functions only in the same account as the rule. We needed a way to send events from other accounts in the organization to our account, and then another mechanism to apply the tags back onto the correct instances in those various accounts.</p><p>We ended up creating an event bus in our Security account, solely for the purpose of receiving these resource creation events from other accounts. Each event rule would send their events to this event bus instead of directly to a Lambda function. The bus, in turn, would be the doorway to our Lambda function, as it would live in the same account as the function itself.</p><p>Next, we created two IAM roles in each managed account. One role has the <code>PutEvent</code> permission, used by the Event Rule to send events to the event bus in the Security account. The second role has the <code>ec2:CreateTags</code> and <code>ec2:DescribeVolumes</code> permission, and its trust policy allows our Lambda&rsquo;s execution role to assume it. CloudFormation is again used to help deploy these to all accounts in scope. It&rsquo;s best to deploy the CloudFormation for creating the IAM roles first, as you can then reference the <code>PutEvent</code> role in your CloudFormation for deploying the Event Rule itself.</p><p>Lastly, we added permissions to our Lambda execution role; namely, a policy to assume the auto tagging role in any account:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;Statement&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;Action&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;sts:AssumeRole&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;Effect&#34;</span><span class=p>:</span> <span class=s2>&#34;Allow&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;Resource&#34;</span><span class=p>:</span> <span class=s2>&#34;arn:aws:iam::*:role/auto-tag-role&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;Sid&#34;</span><span class=p>:</span> <span class=s2>&#34;ResourceAutoTaggerAssumeRole&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;Version&#34;</span><span class=p>:</span> <span class=s2>&#34;2012-10-17&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Once the Lambda function was invoked, it would mostly use the code provided by the AWS blog post example. However, we modified a couple of key areas. We used the source code from the <a href=https://github.com/aws-samples/resource-auto-tagger target=_blank>blog post example GitHub repo</a> and set about modifying <code>resource-auto-tager.py</code>. In the <code>lambda_handler</code> function, we added some code to pull the account ID and region from the CloudTrail event:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Parse the passed CloudTrail event and extract pertinent EC2 launch fields</span>
</span></span><span class=line><span class=cl>    <span class=n>event_fields</span> <span class=o>=</span> <span class=n>cloudtrail_event_parser</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>accountId</span> <span class=o>=</span> <span class=n>event_fields</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;account_id&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>region</span> <span class=o>=</span> <span class=n>event_fields</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;region&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Instance created in Account: </span><span class=si>{</span><span class=n>accountId</span><span class=si>}</span><span class=s2> in region: </span><span class=si>{</span><span class=n>region</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>We then pass <code>accountID</code> and <code>region</code> to the <code>set_ec2_instance_attached_vols_tags</code> function, alongside the <code>ec2_instance_id</code> and <code>resource_tags</code> as seen in the example. Once inside that function, we use the <code>account_id</code> to assume the IAM role that we deployed to every account for the purposes of applying the tags, and build an EC2 client object on the back of that assumed role session and the region.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>set_ec2_instance_attached_vols_tags</span><span class=p>(</span><span class=n>ec2_instance_id</span><span class=p>,</span> <span class=n>resource_tags</span><span class=p>,</span> <span class=n>account_id</span><span class=p>,</span> <span class=n>region</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># First assume the role created in the account that has permission to tag the resources</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Attempting to assume role in target account</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>assumed_role_response</span> <span class=o>=</span> <span class=n>sts_client</span><span class=o>.</span><span class=n>assume_role</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>RoleArn</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;arn:aws:iam::</span><span class=si>{</span><span class=n>account_id</span><span class=si>}</span><span class=s2>:role/auto-tag-role&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>RoleSessionName</span><span class=o>=</span><span class=s2>&#34;auto-tag-session&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>assumed_role_session</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>Session</span><span class=p>(</span><span class=n>aws_access_key_id</span><span class=o>=</span><span class=n>assumed_role_response</span><span class=p>[</span><span class=s1>&#39;Credentials&#39;</span><span class=p>][</span><span class=s1>&#39;AccessKeyId&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                        <span class=n>aws_secret_access_key</span><span class=o>=</span><span class=n>assumed_role_response</span><span class=p>[</span><span class=s1>&#39;Credentials&#39;</span><span class=p>][</span><span class=s1>&#39;SecretAccessKey&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                        <span class=n>aws_session_token</span><span class=o>=</span><span class=n>assumed_role_response</span><span class=p>[</span><span class=s1>&#39;Credentials&#39;</span><span class=p>][</span><span class=s1>&#39;SessionToken&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>assumed_role_ec2_client</span> <span class=o>=</span> <span class=n>assumed_role_session</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s2>&#34;ec2&#34;</span><span class=p>,</span> <span class=n>region_name</span><span class=o>=</span><span class=n>region</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Assumed role in target account successfully</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>Because we have used CloudFormation to deploy the same role to every account, it will be waiting for us, no matter which <code>account_id</code> gets passed in here and used as part of the ARN. And because the Lambda&rsquo;s execution role is trusted by each of those roles in the various accounts, it will be able to assume it without issue. The rest of the code is almost entirely unmodified.</p><p>Stepping back and looking at the complete solution, it can be summarized by this diagram:</p><p><a href=images/autotagdiagram.png><figure><img class="my-0 rounded-md" srcset="/posts/2023-07-31/images/autotagdiagram_hua7627c85062bb552b5e1ab19af875457_159007_330x0_resize_box_3.png 330w,
/posts/2023-07-31/images/autotagdiagram_hua7627c85062bb552b5e1ab19af875457_159007_660x0_resize_box_3.png 660w,
/posts/2023-07-31/images/autotagdiagram_hua7627c85062bb552b5e1ab19af875457_159007_1024x0_resize_box_3.png 1024w,
/posts/2023-07-31/images/autotagdiagram_hua7627c85062bb552b5e1ab19af875457_159007_1320x0_resize_box_3.png 2x" src=/posts/2023-07-31/images/autotagdiagram_hua7627c85062bb552b5e1ab19af875457_159007_660x0_resize_box_3.png alt="A simple diagram showing the flow of events through the solution"></figure></a></p><h2 id=applying-the-service-control-policy class="relative group">Applying the Service Control Policy <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#applying-the-service-control-policy aria-label=Anchor>#</a></span></h2><p>Once the tags are created, we want to prevent someone from removing them, either accidentally or in an attempt to cover their tracks. This can be handled by a pretty straightforward service control policy (SCP) that just blocks the tags that you have decided to apply. In this case, we denied the <code>ec2:DeleteTags</code> action for the <code>owner</code> and <code>dateCreated</code> tags, and attached it to the OU of accounts where we would deploy the solution.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-terraform data-lang=terraform><span class=line><span class=cl><span class=kr>data</span> <span class=s2>&#34;aws_iam_policy_document&#34;</span> <span class=s2>&#34;auto_tag_delete_policy&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>statement</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=na>effect</span>          = <span class=s2>&#34;Deny&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>actions</span>         = <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;ec2:DeleteTags&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=na>resources</span>       = <span class=p>[</span><span class=s2>&#34;*&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=nx>condition</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=na>test</span>        = <span class=s2>&#34;ForAnyValue:StringEquals&#34;</span>
</span></span><span class=line><span class=cl><span class=kr>            variable</span>    <span class=o>=</span> <span class=s2>&#34;aws:TagKeys&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=na>values</span>      = <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;dateCreated&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;owner&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_organizations_policy&#34;</span> <span class=s2>&#34;prevent_auto_tag_delete&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>name</span>                = <span class=s2>&#34;prevent-auto-tag-modification&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>description</span>         = <span class=s2>&#34;Prevents removal of tags automatically applied by InfoSec&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=na>content</span>             = <span class=nb>data</span><span class=p>.</span><span class=nx>aws_iam_policy_document</span><span class=p>.</span><span class=nx>auto_tag_delete_policy</span><span class=p>.</span><span class=nx>json</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_organizations_policy_attachment&#34;</span> <span class=s2>&#34;managed_ou&#34;</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>policy_id</span>           = <span class=nx>aws_organizations_policy</span><span class=p>.</span><span class=nx>prevent_auto_tag_delete</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>    <span class=na>target_id</span>           = <span class=nb>var</span><span class=p>.</span><span class=nx>managed_ou</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=results-and-additional-considerations class="relative group">Results and Additional Considerations <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#results-and-additional-considerations aria-label=Anchor>#</a></span></h2><p>Once everything was in place and enabled, tags began being automatically applied to our EC2 instances as they were created.</p><p><a href=images/tagscreated.png><figure><img class="my-0 rounded-md" srcset="/posts/2023-07-31/images/tagscreated_hu9411a1284489b798d2546ac56e483c49_21659_330x0_resize_box_3.png 330w,
/posts/2023-07-31/images/tagscreated_hu9411a1284489b798d2546ac56e483c49_21659_660x0_resize_box_3.png 660w,
/posts/2023-07-31/images/tagscreated_hu9411a1284489b798d2546ac56e483c49_21659_1024x0_resize_box_3.png 1024w,
/posts/2023-07-31/images/tagscreated_hu9411a1284489b798d2546ac56e483c49_21659_1320x0_resize_box_3.png 2x" src=/posts/2023-07-31/images/tagscreated_hu9411a1284489b798d2546ac56e483c49_21659_660x0_resize_box_3.png alt="An example of the dateCreated and owner tags applied to an instance"></figure></a></p><p>Through an extensive testing and monitoring process, I learned a few things and wanted to point out some additional things to keep in mind:</p><ul><li>Regions further away from where your event bus and Lambda function are will take a few seconds longer to have tags applied to them, due to round trip times. Make sure you adjust the default Lambda timeout threshold to something like 3 minutes just to make sure you&rsquo;re not losing any tagging due to a slightly delayed event.</li><li>While the SCP prevents someone from deleting the tags, it does nothing to stop them from modifying them. Overwriting tags falls under the <code>ec2:CreateTags</code> permission, which is what is used to apply these tags in the first place. Therefore, it would be trivial for someone to edit the <code>owner</code> tag after the fact to cover their own tracks. It is recommended you combine this solution with a tool or service that takes routine inventory snapshots of your instance fleet, such as <a href=https://www.cloudquery.io/ target=_blank>CloudQuery</a> so that you can track changes to tags over time.</li><li>We actually ended up adding an additional tag called &ldquo;WhatIsThis&rdquo; with a value that was a URL that pointed to a page on our internal security wiki explaining what auto-tagging was and why it was being applied to resources. While we sent out communications to the account owners and administrators prior to rolling the solution out, there was still going to be some users who would be confused why certain tags were being applied to instances that they had created. Depending on your organization&rsquo;s culture, it may be a good idea to include something like this to prevent a torrent of emails or Slack messages inquiring about the tags.</li><li>If your organization has teams already using infrastructure as code to manage their resources, they may need to add some configuration to ignore these tags as sources of drift. For example, Terraform has an <code>ignore_tags</code> <a href=https://registry.terraform.io/providers/hashicorp/aws/latest/docs#ignore_tags target=_blank>configuration block for the AWS provider</a> that will allow the automatically applied tags to be ignored.</li><li>For accounts that routinely spin up large numbers of EC2 instances at the same time, make sure you review the current rate limits and quotas for the <code>DescribeInstances</code>, <code>CreateTags</code>, and <code>DescribeVolumes</code> API calls, as you can quickly hit the rate limit when large numbers of resources are created concurrently.</li><li>Although this solution works great for newly created EC2 instances, it does nothing for instances that already exist. For those use cases, you&rsquo;re probably better off using something like <a href=https://github.com/wolfeidau/aws-billing-store/ target=_blank>Mark Wolfe&rsquo;s excellent project</a> that automates pushing Cost and Usage report information into an Athena table.</li></ul><p>It is my hope that this post helps others fill in this gap in their own AWS security and compliance posture. I&rsquo;m always happy to discuss this solution, especially ways it can be improved, if you wish to <a href=../../contact>reach out</a>.</p></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=flex><img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width=96 height=96 alt="John Misczak" src=/img/author_hub50b6b8a906c93a65ba8a4369efaedb9_111822_192x192_fill_q75_box_smart1.jpg><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">John Misczak</div><div class="text-sm text-neutral-700 dark:text-neutral-400">Security Engineer</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/misczak target=_blank aria-label=Github rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" href=https://linkedin.com/in/johnmisczak target=_blank aria-label=Linkedin rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg></span></a><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" href=https://infosec.exchange/@misczak target=_blank aria-label=Mastodon rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg></span></a></div></div></div></div><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="group flex" href=/posts/2023-02-27/><span class="mr-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-2 text-neutral-700 transition-transform group-hover:translate-x-[2px] group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Building on GCP</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2023-02-27 00:00:00 +0000 UTC">February 27 2023</time></span></span></a></span>
<span><a class="group flex text-right" href=/posts/2023-08-18/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Google's Professional Cloud Security Engineer Certification</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2023-08-18 00:00:00 +0000 UTC">August 18 2023</time></span></span>
<span class="ml-2 text-neutral-700 transition-transform group-hover:translate-x-[2px] group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div class="pointer-events-none absolute top-[100vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2024
John Misczak</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://git.io/hugo-congo target=_blank rel="noopener noreferrer">Congo</a></p></div></div></footer></div></body></html>