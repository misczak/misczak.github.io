<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="rgb(255,255,255)"><meta http-equiv=x-ua-compatible content="ie=edge"><title>Building Event Driven Experiences with MongoDB Realm and AWS &#183; /misczak</title><meta name=title content="Building Event Driven Experiences with MongoDB Realm and AWS &#183; /misczak"><meta name=description content="Using MongoDB Realm triggers and functions to connect to AWS services."><link rel=canonical href=https://misczak.github.io/posts/2022-03-20/><link type=text/css rel=stylesheet href=/css/main.bundle.min.b15bed9c75c13ca3a738d365165ea777e34f367687cb02db8605dcf7786b76165f84c3f19f2c5d126d63d5597fe5ea155750bc6b0d4b822e90a9a8641b628437.css integrity="sha512-sVvtnHXBPKOnONNlFl6nd+NPNnaHywLbhgXc93hrdhZfhMPxnyxdEm1j1Vl/5eoVV1C8aw1Lgi6QqahkG2KENw=="><script type=text/javascript src=/js/appearance.min.1e44157c1e51b46341ce2c94716dd3dd1ef30c28e7d1c9f3b9db80877bfe72bc66b00d8a662f317840016acbed93c5f18c3d9268c8b957021ee74d0b04adf6c5.js integrity="sha512-HkQVfB5RtGNBziyUcW3T3R7zDCjn0cnzuduAh3v+crxmsA2KZi8xeEABasvtk8XxjD2SaMi5VwIe500LBK32xQ=="></script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="Building Event Driven Experiences with MongoDB Realm and AWS"><meta property="og:description" content="Using MongoDB Realm triggers and functions to connect to AWS services."><meta property="og:type" content="article"><meta property="og:url" content="https://misczak.github.io/posts/2022-03-20/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-20T00:00:00+00:00"><meta property="article:modified_time" content="2022-03-20T00:00:00+00:00"><meta property="og:site_name" content="/misczak"><meta name=twitter:card content="summary"><meta name=twitter:title content="Building Event Driven Experiences with MongoDB Realm and AWS"><meta name=twitter:description content="Using MongoDB Realm triggers and functions to connect to AWS services."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"Building Event Driven Experiences with MongoDB Realm and AWS","headline":"Building Event Driven Experiences with MongoDB Realm and AWS","description":"Using MongoDB Realm triggers and functions to connect to AWS services.","abstract":"Disclaimer: I am a MongoDB employee.","inLanguage":"en","url":"https:\/\/misczak.github.io\/posts\/2022-03-20\/","author":{"@type":"Person","name":"John Misczak"},"copyrightYear":"2022","dateCreated":"2022-03-20T00:00:00\u002b00:00","datePublished":"2022-03-20T00:00:00\u002b00:00","dateModified":"2022-03-20T00:00:00\u002b00:00","keywords":["MongoDB","AWS","NodeJS"],"mainEntityOfPage":"true","wordCount":"1896"}]</script><meta name=author content="John Misczak"><link href=https://bsky.app/profile/misczak.bsky.social rel=me><link href=https://github.com/misczak rel=me><link href=https://linkedin.com/in/johnmisczak rel=me></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold text-neutral-900 dark:text-neutral print:hidden sm:py-10"><nav class="flex items-start justify-between sm:items-center"><div class="flex flex-row items-center"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>/misczak</a></div><ul class="flex list-none flex-col ltr:text-right rtl:text-left sm:flex-row"><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/posts/ title=Posts>Blog</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/about/ title>About</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/categories/ title=Categories>Categories</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/archive/ title=Archive>Archive</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/contact/ title>Contact</a></li></ul></nav></header><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header class=max-w-prose><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Building Event Driven Experiences with MongoDB Realm and AWS</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2022-03-20 00:00:00 +0000 UTC">March 20 2022</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">9 mins</span></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first px-0 lg:order-last lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-10"><details open class="mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#pre-requisites>Pre-requisites</a></li><li><a href=#emulating-an-application-environment>Emulating an application environment</a><ul><li><a href=#set-up-mongodb-cluster>Set up MongoDB Cluster</a></li><li><a href=#set-up-the-s3-bucket>Set up the S3 Bucket</a></li><li><a href=#set-up-parameters-in-ssm>Set up parameters in SSM</a></li></ul></li><li><a href=#configuring-mongodb-atlas-and-realm>Configuring MongoDB Atlas and Realm</a><ul><li><a href=#load-data-into-cluster>Load Data Into Cluster</a></li><li><a href=#set-up-realm-app>Set up Realm App</a></li><li><a href=#set-up-realm-values-and-secrets>Set up Realm Values and Secrets</a></li><li><a href=#create-realm-functions>Create Realm Functions</a></li></ul></li><li><a href=#deploying-and-testing>Deploying and Testing</a></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-prose grow"><p>Disclaimer: I am a MongoDB employee.</p><p>Most developers by now are familiar with MongoDB, a NoSQL database that stores data as documents instead of rows. MongoDB&rsquo;s fully managed service product, MongoDB Atlas, comes with MongoDB Realm, which is a set of services that help facilitate mobile and web development by providing a scalable, serverless backend for your application. Realm offers a lot of services (more than we can cover in just this post), but today I wanted to focus on how to use two of them in tandem to help connect a MongoDB Atlas database into a distributed, event driven architecture that can be built on AWS.</p><h2 id=pre-requisites class="relative group">Pre-requisites <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#pre-requisites aria-label=Anchor>#</a></span></h2><p>Before we get started, there are a couple of things you should have setup already. These include:</p><ol><li><p>An AWS account with an IAM user created, and an access key created for that IAM user. The user should have permissions to create, edit, and retrieve parameters from AWS Systems Manager and put objects, list buckets, and get objects from S3.</p></li><li><p>A MongoDB Atlas account. It is <a href=https://www.mongodb.com/cloud/atlas/register target=_blank>free to sign up</a>, and there is a free tier that you can use to follow along with this post. The Community version of MongoDB does not include MongoDB Realm, so this post does not apply to it.</p></li></ol><h2 id=emulating-an-application-environment class="relative group">Emulating an application environment <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#emulating-an-application-environment aria-label=Anchor>#</a></span></h2><p>We&rsquo;re going to have to setup a few things to make this look and feel like an environment a real application is using. Most modern applications are not just writing data to a database and reading it back; rather, they are consuming events from/publishing events to a message queue or stream, interacting with cloud storage, and relying on slight changes to data to kick off workflows. To keep things simple, our goal will be to monitor our database for new documents that are inserted and to upload a copy of them to S3 at the exact moment they are written to the database. In our theoretical application, we are using the copy of the document to do some additional processing or analysis with an AWS service that is reading from S3.</p><h3 id=set-up-mongodb-cluster class="relative group">Set up MongoDB Cluster <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#set-up-mongodb-cluster aria-label=Anchor>#</a></span></h3><p>Log into your MongoDB Atlas account. Create a project to act as the container for your cluster, then create a cluster. If you want to use the free tier, choose the <strong>Shared</strong> category at the top of the Create Cluster page. Use a recommended, free-tier region such as <code>us-east-1</code> or <code>us-east-2</code> and then scroll down select the <strong>M0 Sandbox</strong> Cluster Tier. Change the name of the cluster from <strong>Cluster0</strong> to <strong>Sandbox</strong> and click on <strong>Create Cluster</strong>.</p><h3 id=set-up-the-s3-bucket class="relative group">Set up the S3 Bucket <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#set-up-the-s3-bucket aria-label=Anchor>#</a></span></h3><p>While the MongoDB cluster is creating, head over to the AWS console and login as your IAM user. Go to Amazon S3 in the AWS console and choose <strong>Create bucket</strong>. Give it a name like <code>{yourname}-event-bucket</code> and select the same region that you created your MongoDB Atlas cluster in. Leave the other options as the default selections and click <strong>Create bucket</strong> at the bottom of the page.</p><h3 id=set-up-parameters-in-ssm class="relative group">Set up parameters in SSM <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#set-up-parameters-in-ssm aria-label=Anchor>#</a></span></h3><p>In the AWS console, search for AWS Systems Manager (SSM) and navigate to the service page. Once there, select <strong>Parameter Store</strong> on the left hand navigation, under Application Management. Select <strong>Create Parameter</strong>.</p><p>On the Create parameter page, enter <code>event-target-bucket</code> as the name for the parameter. Leave the Tier as Standard, the Type as String, and the Data type as text. Under value, enter the name of the S3 bucket you created in the previous step.</p><p><figure><img class="my-0 rounded-md" srcset="/posts/2022-03-20/images/ssm_hue9a630aed25c6386f26823215d349708_68111_330x0_resize_box_3.png 330w,
/posts/2022-03-20/images/ssm_hue9a630aed25c6386f26823215d349708_68111_660x0_resize_box_3.png 660w,
/posts/2022-03-20/images/ssm_hue9a630aed25c6386f26823215d349708_68111_1024x0_resize_box_3.png 1024w,
/posts/2022-03-20/images/ssm_hue9a630aed25c6386f26823215d349708_68111_1320x0_resize_box_3.png 2x" src=/posts/2022-03-20/images/ssm_hue9a630aed25c6386f26823215d349708_68111_660x0_resize_box_3.png alt="Setting the SSM Parameter for S3 bucket name"></figure></p><h2 id=configuring-mongodb-atlas-and-realm class="relative group">Configuring MongoDB Atlas and Realm <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#configuring-mongodb-atlas-and-realm aria-label=Anchor>#</a></span></h2><h3 id=load-data-into-cluster class="relative group">Load Data Into Cluster <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#load-data-into-cluster aria-label=Anchor>#</a></span></h3><p>Return to the MongoDB Atlas console. When your sandbox is finished provisioning, click the <strong>&mldr;</strong> button and choose <strong>Load Sample Dataset</strong>. This will give us a few databases and collections of data to use for our testing purposes.</p><p><figure><img class="my-0 rounded-md" srcset="/posts/2022-03-20/images/atlassandbox_hu3be95dba7d6c059e87de918085f2ac1c_32082_330x0_resize_box_3.png 330w,
/posts/2022-03-20/images/atlassandbox_hu3be95dba7d6c059e87de918085f2ac1c_32082_660x0_resize_box_3.png 660w,
/posts/2022-03-20/images/atlassandbox_hu3be95dba7d6c059e87de918085f2ac1c_32082_1024x0_resize_box_3.png 1024w,
/posts/2022-03-20/images/atlassandbox_hu3be95dba7d6c059e87de918085f2ac1c_32082_1320x0_resize_box_3.png 2x" src=/posts/2022-03-20/images/atlassandbox_hu3be95dba7d6c059e87de918085f2ac1c_32082_660x0_resize_box_3.png alt="Loading sample data into MongoDB Atlas"></figure></p><h3 id=set-up-realm-app class="relative group">Set up Realm App <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#set-up-realm-app aria-label=Anchor>#</a></span></h3><p>While that data is being loaded, click on the <strong>Realm</strong> tab near the top of the screen. We want to select <strong>Create a New App</strong> and name it <code>AWS-Event-App</code>. Under &ldquo;Link your Database&rdquo;, select <strong>Use an existing MongoDB Atlas Data Source</strong> and choose the Sandbox cluster you created. Then click <strong>Create Realm Application</strong>.</p><p><figure><img class="my-0 rounded-md" srcset="/posts/2022-03-20/images/createrealmapp_hu84d68798c2275eb37214ac25411b899e_60539_330x0_resize_box_3.png 330w,
/posts/2022-03-20/images/createrealmapp_hu84d68798c2275eb37214ac25411b899e_60539_660x0_resize_box_3.png 660w,
/posts/2022-03-20/images/createrealmapp_hu84d68798c2275eb37214ac25411b899e_60539_1024x0_resize_box_3.png 1024w,
/posts/2022-03-20/images/createrealmapp_hu84d68798c2275eb37214ac25411b899e_60539_1320x0_resize_box_3.png 2x" src=/posts/2022-03-20/images/createrealmapp_hu84d68798c2275eb37214ac25411b899e_60539_660x0_resize_box_3.png alt="Creating a MongoDB Realm App"></figure></p><h3 id=set-up-realm-values-and-secrets class="relative group">Set up Realm Values and Secrets <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#set-up-realm-values-and-secrets aria-label=Anchor>#</a></span></h3><p>In order to hook into our AWS account and use the bucket and the parameter we just set up, we have to authenticate to the account from MongoDB Realm. Since we&rsquo;ll be using our AWS IAM user&rsquo;s access key and secret key, we don&rsquo;t want to hardcode it into any code we end up writing or reading from source control. Therefore, we will use Realm&rsquo;s Values feature to securely store these values.</p><p>Realm&rsquo;s Values feature allows you to store two types of values - regular values and secrets. Secrets cannot be directly accessed by the Realm API; instead, they must be mapped to their own regular value in order to be able to be retrieved. This prevents you from inadvertantly exposing a secret you did not intend to.</p><p>Click on <strong>Values</strong> in the left hand navigation of your Realm app. Click on <strong>Create New Value</strong>. For the value&rsquo;s name, enter <code>AccessKeyID</code>. Choose <code>Value</code> as the type, then for Content select <code>Custom Content</code> and paste in your Access Key wrapped in double quotations to mark it as a string. Then click on <strong>Save Draft</strong>.</p><p><figure><img class="my-0 rounded-md" srcset="/posts/2022-03-20/images/realmvalue1_hufa1986b7bdd9b2cc1e23083ac7cabedf_55670_330x0_resize_box_3.png 330w,
/posts/2022-03-20/images/realmvalue1_hufa1986b7bdd9b2cc1e23083ac7cabedf_55670_660x0_resize_box_3.png 660w,
/posts/2022-03-20/images/realmvalue1_hufa1986b7bdd9b2cc1e23083ac7cabedf_55670_1024x0_resize_box_3.png 1024w,
/posts/2022-03-20/images/realmvalue1_hufa1986b7bdd9b2cc1e23083ac7cabedf_55670_1320x0_resize_box_3.png 2x" src=/posts/2022-03-20/images/realmvalue1_hufa1986b7bdd9b2cc1e23083ac7cabedf_55670_660x0_resize_box_3.png alt="Setting up the Access Key ID as a Realm Value"></figure></p><p>Click on <strong>Create New Value</strong> again. Enter <code>SecretAccessKeySecret</code> as the value name, and this time select <code>Secret</code> under Type. For the value of secret, paste in your AWS IAM user&rsquo;s Secret Access Key, then click <strong>Save Draft</strong>.</p><p><figure><img class="my-0 rounded-md" srcset="/posts/2022-03-20/images/realmsecret_hu5d929357a5e4f2aac9aca7ec66859b15_44853_330x0_resize_box_3.png 330w,
/posts/2022-03-20/images/realmsecret_hu5d929357a5e4f2aac9aca7ec66859b15_44853_660x0_resize_box_3.png 660w,
/posts/2022-03-20/images/realmsecret_hu5d929357a5e4f2aac9aca7ec66859b15_44853_1024x0_resize_box_3.png 1024w,
/posts/2022-03-20/images/realmsecret_hu5d929357a5e4f2aac9aca7ec66859b15_44853_1320x0_resize_box_3.png 2x" src=/posts/2022-03-20/images/realmsecret_hu5d929357a5e4f2aac9aca7ec66859b15_44853_660x0_resize_box_3.png alt="Setting up the Secret Key as a Realm Secret"></figure></p><p>We&rsquo;ve entered the Secret Access Key, but we cannot directly access it via the Realm API since it is a secret. We now have to create a value and map it to that secret. Click on <strong>Create New Value</strong> a third time. Enter <code>SecretAccessKey</code> and select <code>Value</code> as the type. Under Add Content, choose <code>Link to Secret</code> and select the <code>SecretAccessKeySecret</code> you just created. Click <strong>Save Draft</strong>.</p><p><figure><img class="my-0 rounded-md" srcset="/posts/2022-03-20/images/realmvalue2_hu8a8b868bff818f87161a2149cfdd4806_54840_330x0_resize_box_3.png 330w,
/posts/2022-03-20/images/realmvalue2_hu8a8b868bff818f87161a2149cfdd4806_54840_660x0_resize_box_3.png 660w,
/posts/2022-03-20/images/realmvalue2_hu8a8b868bff818f87161a2149cfdd4806_54840_1024x0_resize_box_3.png 1024w,
/posts/2022-03-20/images/realmvalue2_hu8a8b868bff818f87161a2149cfdd4806_54840_1320x0_resize_box_3.png 2x" src=/posts/2022-03-20/images/realmvalue2_hu8a8b868bff818f87161a2149cfdd4806_54840_660x0_resize_box_3.png alt="Linking a Realm Value to the Realm Secret"></figure></p><p>We have one more value to set up before we&rsquo;re done. Click on <strong>Create New Value</strong> again, and this time enter <code>Region</code> as the value name. Leave Type as <code>Value</code> and Add Content as <code>Custom Content</code>. In the content field, enter the AWS region where you set up your S3 bucket and SSM parameter, again wrapped in double quotations. Then click <strong>Save Draft</strong>.</p><p>You may ask why we bothered with SSM at all to store the parameter of the S3 bucket name. It is true that we could also store the bucket name here in Realm&rsquo;s values; however, for the scope of the post we will assume the application environment has already been using SSM for parameters such as these, and therefore it will be less work for us to leave it that way.</p><h3 id=create-realm-functions class="relative group">Create Realm Functions <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#create-realm-functions aria-label=Anchor>#</a></span></h3><p>Now we are ready to start writing some code. First, let&rsquo;s bring in the AWS SDK which we will use in our code to make calls to the specific AWS services we will use. Select <strong>Functions</strong> in the left hand navigation then click the <strong>Dependencies</strong> tab at the top of the page. Select <strong>Add Dependency</strong>. On the modal that appears, enter <code>aws-sdk</code> as the package name. You can leave the version blank, but if you run into issues, you may want to come back and change the version to 2.737.0, which is what I used to write this post. When you&rsquo;re done, click <strong>Add</strong>.</p><p><figure><img class="my-0 rounded-md" srcset="/posts/2022-03-20/images/realmnpmlibrary_hu95cbfde720d796ba83e02bfc48e4172d_33273_330x0_resize_box_3.png 330w,
/posts/2022-03-20/images/realmnpmlibrary_hu95cbfde720d796ba83e02bfc48e4172d_33273_660x0_resize_box_3.png 660w,
/posts/2022-03-20/images/realmnpmlibrary_hu95cbfde720d796ba83e02bfc48e4172d_33273_1024x0_resize_box_3.png 1024w,
/posts/2022-03-20/images/realmnpmlibrary_hu95cbfde720d796ba83e02bfc48e4172d_33273_1320x0_resize_box_3.png 2x" src=/posts/2022-03-20/images/realmnpmlibrary_hu95cbfde720d796ba83e02bfc48e4172d_33273_660x0_resize_box_3.png alt="Adding the aws-sdk library as a dependency"></figure></p><p>The <code>aws-sdk</code> node library should be added as a dependency. Now click <strong>Create New Function</strong> button in the upper right. In the Add Function page, enter <code>MoveDocToQueue</code> as the function and for now choose <code>System</code> under Authentication. Click on the <strong>Function Editor</strong> tab at the top, and paste this code in over what is currently there.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>exports</span> <span class=o>=</span> <span class=kr>async</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>){</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>AWS</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;aws-sdk&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>config</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>accessKeyId</span><span class=o>:</span> <span class=nx>context</span><span class=p>.</span><span class=nx>values</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;AccessKeyID&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>secretAccessKey</span><span class=o>:</span> <span class=nx>context</span><span class=p>.</span><span class=nx>values</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;SecretAccessKey&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>region</span><span class=o>:</span> <span class=nx>context</span><span class=p>.</span><span class=nx>values</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>&#34;Region&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>SSMparams</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span><span class=o>:</span> <span class=s1>&#39;event-target-bucket&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>WithDecryption</span><span class=o>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>doc</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>fullDocument</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>SSM</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>AWS</span><span class=p>.</span><span class=nx>SSM</span><span class=p>(</span><span class=nx>config</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>ssmPromise</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>SSM</span><span class=p>.</span><span class=nx>getParameter</span><span class=p>(</span><span class=nx>SSMparams</span><span class=p>).</span><span class=nx>promise</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>bucketName</span> <span class=o>=</span> <span class=nx>ssmPromise</span><span class=p>.</span><span class=nx>Parameter</span><span class=p>.</span><span class=nx>Value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>S3params</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Bucket</span><span class=o>:</span> <span class=nx>bucketName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>Key</span><span class=o>:</span> <span class=s2>&#34;queue-&#34;</span> <span class=o>+</span> <span class=nx>event</span><span class=p>.</span><span class=nx>fullDocument</span><span class=p>.</span><span class=nx>_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>Body</span><span class=o>:</span> <span class=nx>doc</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>S3</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>AWS</span><span class=p>.</span><span class=nx>S3</span><span class=p>(</span><span class=nx>config</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>s3Promise</span> <span class=o>=</span> <span class=nx>S3</span><span class=p>.</span><span class=nx>putObject</span><span class=p>(</span><span class=nx>S3params</span><span class=p>).</span><span class=nx>promise</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>s3Promise</span><span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Put Object Success&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}).</span><span class=k>catch</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p><figure><img class="my-0 rounded-md" srcset="/posts/2022-03-20/images/realmfunction1_hue90326d05fef9b55a85aef784287ac7b_47117_330x0_resize_box_3.png 330w,
/posts/2022-03-20/images/realmfunction1_hue90326d05fef9b55a85aef784287ac7b_47117_660x0_resize_box_3.png 660w,
/posts/2022-03-20/images/realmfunction1_hue90326d05fef9b55a85aef784287ac7b_47117_1024x0_resize_box_3.png 1024w,
/posts/2022-03-20/images/realmfunction1_hue90326d05fef9b55a85aef784287ac7b_47117_1320x0_resize_box_3.png 2x" src=/posts/2022-03-20/images/realmfunction1_hue90326d05fef9b55a85aef784287ac7b_47117_660x0_resize_box_3.png alt="Configuring the Realm Function"></figure></p><p><figure><img class="my-0 rounded-md" srcset="/posts/2022-03-20/images/realmfunction2_huadc47db9a0b93839bb3aabdbdd975af4_65039_330x0_resize_box_3.png 330w,
/posts/2022-03-20/images/realmfunction2_huadc47db9a0b93839bb3aabdbdd975af4_65039_660x0_resize_box_3.png 660w,
/posts/2022-03-20/images/realmfunction2_huadc47db9a0b93839bb3aabdbdd975af4_65039_1024x0_resize_box_3.png 1024w,
/posts/2022-03-20/images/realmfunction2_huadc47db9a0b93839bb3aabdbdd975af4_65039_1320x0_resize_box_3.png 2x" src=/posts/2022-03-20/images/realmfunction2_huadc47db9a0b93839bb3aabdbdd975af4_65039_660x0_resize_box_3.png alt="Editing the code of the Realm Function"></figure></p><p>Normally with Realm functions, you can click on <strong>Run</strong> near the bottom right to test out the function. However, since this function will require a change event in the database to run, we will need to map it to a trigger first and modify some data to test it out. For now, click on <strong>Save Draft</strong>.</p><p>We now have the actual code we want to run to move documents to our S3 bucket. But how do we get it to run whenever we insert data? The answer is a Realm Trigger. Select <strong>Triggers</strong> on the left hand navigation, then add a new trigger.</p><p>On the Add Trigger page, enter <code>moveDocToQueueTrigger</code> as the name, then select your Sandbox cluster under Trigger Source Details. For database, select <code>sample_mflix</code> and for collection select <code>movies</code>. Under Operation type, ensure <code>Insert</code> is checked as we want this trigger to fire on every new document inserted into the sample_mflix.movies collection. Keep scrolling down and ensure that Full Document is turned to <code>ON</code>. Under Select an Event Type, choose Function and select the <code>MoveDocToQueue</code> function that we just created. Then click <strong>Save</strong>.</p><p><figure><img class="my-0 rounded-md" srcset="/posts/2022-03-20/images/realmtrigger1_huf671fb6f0cabfc4c04d4b678655a370f_79612_330x0_resize_box_3.png 330w,
/posts/2022-03-20/images/realmtrigger1_huf671fb6f0cabfc4c04d4b678655a370f_79612_660x0_resize_box_3.png 660w,
/posts/2022-03-20/images/realmtrigger1_huf671fb6f0cabfc4c04d4b678655a370f_79612_1024x0_resize_box_3.png 1024w,
/posts/2022-03-20/images/realmtrigger1_huf671fb6f0cabfc4c04d4b678655a370f_79612_1320x0_resize_box_3.png 2x" src=/posts/2022-03-20/images/realmtrigger1_huf671fb6f0cabfc4c04d4b678655a370f_79612_660x0_resize_box_3.png alt="Configuring the Realm Trigger Part 1"></figure></p><p><figure><img class="my-0 rounded-md" srcset="/posts/2022-03-20/images/realmtrigger2_hu4754f86dec4ac3e4d7bfbae7902545a9_58125_330x0_resize_box_3.png 330w,
/posts/2022-03-20/images/realmtrigger2_hu4754f86dec4ac3e4d7bfbae7902545a9_58125_660x0_resize_box_3.png 660w,
/posts/2022-03-20/images/realmtrigger2_hu4754f86dec4ac3e4d7bfbae7902545a9_58125_1024x0_resize_box_3.png 1024w,
/posts/2022-03-20/images/realmtrigger2_hu4754f86dec4ac3e4d7bfbae7902545a9_58125_1320x0_resize_box_3.png 2x" src=/posts/2022-03-20/images/realmtrigger2_hu4754f86dec4ac3e4d7bfbae7902545a9_58125_660x0_resize_box_3.png alt="Configuring the Realm Trigger Part 2"></figure></p><h2 id=deploying-and-testing class="relative group">Deploying and Testing <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#deploying-and-testing aria-label=Anchor>#</a></span></h2><p>We are now ready to try our first test! On the blue banner at the top of the page, you can now choose to Deploy the changes to your Realm app. The values, secrets, function, and trigger should now be ready to go. Open up a connection to your MongoDB cluster and insert a new document into the <code>sample_mflix.movies</code> collection. You can do this via the <a href=https://www.mongodb.com/try/download/shell target=_blank>mongo shell</a>, a MongoDB driver, <a href=https://www.mongodb.com/products/compass target=_blank>MongoDB Compass</a>, or just by using the Data Explorer built into Atlas to duplicate an existing document in that collection. Keep in mind that if you are using the shell, a driver, or Compass, you will need to <a href=https://docs.atlas.mongodb.com/security/add-ip-address-to-list/ target=_blank>add your current IP address to the IP Access list</a> in your Atlas project.</p><p>After you have inserted a new document, return to MongoDB Realm and select Logs in the left hand navigation. You should an entry in the History showing when your trigger was invoked. Expanding the entry will show you the logs from that particular function - if you set up your values and secrets correctly, you should see the log message &ldquo;Put Object Success&rdquo;, meaning that our attempt to put the document into the S3 bucket appears to be successful. (If you do not see this output, double check your values and secrets, your IAM user permissions, and your S3 and SSM configuration.)</p><p><figure><img class="my-0 rounded-md" srcset="/posts/2022-03-20/images/logoutput_hu6e7bc1e5d09c8696bd06b79d4914ff61_37411_330x0_resize_box_3.png 330w,
/posts/2022-03-20/images/logoutput_hu6e7bc1e5d09c8696bd06b79d4914ff61_37411_660x0_resize_box_3.png 660w,
/posts/2022-03-20/images/logoutput_hu6e7bc1e5d09c8696bd06b79d4914ff61_37411_1024x0_resize_box_3.png 1024w,
/posts/2022-03-20/images/logoutput_hu6e7bc1e5d09c8696bd06b79d4914ff61_37411_1320x0_resize_box_3.png 2x" src=/posts/2022-03-20/images/logoutput_hu6e7bc1e5d09c8696bd06b79d4914ff61_37411_660x0_resize_box_3.png alt="Seeing the log output showing a successful upload"></figure></p><p>Let&rsquo;s double check that this actually sent the document to S3 by going back to our AWS console and navigating to the S3 service page. Find the bucket that you created at the beginning of this process and open it up. You should see an object in there starting with <code>queue-</code> and then the _id value of the document you inserted. The object is named this way because we set this as the Key value when setting up the S3 parameters in our Realm function. If you see the document, then your setup is successful!</p><p><figure><img class="my-0 rounded-md" srcset="/posts/2022-03-20/images/s3result_hu69e7b8414918e88e25f0e5831c782da3_41907_330x0_resize_box_3.png 330w,
/posts/2022-03-20/images/s3result_hu69e7b8414918e88e25f0e5831c782da3_41907_660x0_resize_box_3.png 660w,
/posts/2022-03-20/images/s3result_hu69e7b8414918e88e25f0e5831c782da3_41907_1024x0_resize_box_3.png 1024w,
/posts/2022-03-20/images/s3result_hu69e7b8414918e88e25f0e5831c782da3_41907_1320x0_resize_box_3.png 2x" src=/posts/2022-03-20/images/s3result_hu69e7b8414918e88e25f0e5831c782da3_41907_660x0_resize_box_3.png alt="Seeing the document show up in S3"></figure></p><p>You can continue experimenting by bringing in other AWS services as well, such as sending the document to a Kinesis data stream instead of just an S3 bucket.</p></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=flex><img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width=96 height=96 alt="John Misczak" src=/img/author_hub50b6b8a906c93a65ba8a4369efaedb9_111822_192x192_fill_q75_box_smart1.jpg><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">John Misczak</div><div class="text-sm text-neutral-700 dark:text-neutral-400">Security Engineer</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" href=https://bsky.app/profile/misczak.bsky.social target=_blank aria-label=Bluesky rel="me noopener noreferrer"></a><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/misczak target=_blank aria-label=Github rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" href=https://linkedin.com/in/johnmisczak target=_blank aria-label=Linkedin rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg></span></a></div></div></div></div><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span></span><span><a class="group flex text-right" href=/posts/2022-05-30/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Tracking Temperature and Humidity at Home with Time Series Data</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2022-05-30 00:00:00 +0000 UTC">May 30 2022</time></span></span>
<span class="ml-2 text-neutral-700 transition-transform group-hover:translate-x-[2px] group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div class="pointer-events-none absolute top-[100vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2024
John Misczak</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://git.io/hugo-congo target=_blank rel="noopener noreferrer">Congo</a></p></div></div></footer></div></body></html>