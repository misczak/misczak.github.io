<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="rgb(255,255,255)"><meta http-equiv=x-ua-compatible content="ie=edge"><title>Tracking Temperature and Humidity at Home with Time Series Data &#183; /misczak</title><meta name=title content="Tracking Temperature and Humidity at Home with Time Series Data &#183; /misczak"><meta name=description content="Generating temperature and humidity time series data and using MongoDB's time series collections, charts and window functions to analyze it."><link rel=canonical href=https://misczak.github.io/posts/2022-05-30/><link type=text/css rel=stylesheet href=/css/main.bundle.min.b15bed9c75c13ca3a738d365165ea777e34f367687cb02db8605dcf7786b76165f84c3f19f2c5d126d63d5597fe5ea155750bc6b0d4b822e90a9a8641b628437.css integrity="sha512-sVvtnHXBPKOnONNlFl6nd+NPNnaHywLbhgXc93hrdhZfhMPxnyxdEm1j1Vl/5eoVV1C8aw1Lgi6QqahkG2KENw=="><script type=text/javascript src=/js/appearance.min.1e44157c1e51b46341ce2c94716dd3dd1ef30c28e7d1c9f3b9db80877bfe72bc66b00d8a662f317840016acbed93c5f18c3d9268c8b957021ee74d0b04adf6c5.js integrity="sha512-HkQVfB5RtGNBziyUcW3T3R7zDCjn0cnzuduAh3v+crxmsA2KZi8xeEABasvtk8XxjD2SaMi5VwIe500LBK32xQ=="></script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="Tracking Temperature and Humidity at Home with Time Series Data"><meta property="og:description" content="Generating temperature and humidity time series data and using MongoDB's time series collections, charts and window functions to analyze it."><meta property="og:type" content="article"><meta property="og:url" content="https://misczak.github.io/posts/2022-05-30/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-30T00:00:00+00:00"><meta property="article:modified_time" content="2022-05-30T00:00:00+00:00"><meta property="og:site_name" content="/misczak"><meta name=twitter:card content="summary"><meta name=twitter:title content="Tracking Temperature and Humidity at Home with Time Series Data"><meta name=twitter:description content="Generating temperature and humidity time series data and using MongoDB's time series collections, charts and window functions to analyze it."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"Tracking Temperature and Humidity at Home with Time Series Data","headline":"Tracking Temperature and Humidity at Home with Time Series Data","description":"Generating temperature and humidity time series data and using MongoDB\u0027s time series collections, charts and window functions to analyze it.","abstract":"Disclaimer: I am a MongoDB employee.","inLanguage":"en","url":"https:\/\/misczak.github.io\/posts\/2022-05-30\/","author":{"@type":"Person","name":"John Misczak"},"copyrightYear":"2022","dateCreated":"2022-05-30T00:00:00\u002b00:00","datePublished":"2022-05-30T00:00:00\u002b00:00","dateModified":"2022-05-30T00:00:00\u002b00:00","keywords":["MongoDB","Raspberry Pi","Python"],"mainEntityOfPage":"true","wordCount":"2061"}]</script><meta name=author content="John Misczak"><link href=https://github.com/misczak rel=me><link href=https://linkedin.com/in/johnmisczak rel=me><link href=https://infosec.exchange/@misczak rel=me></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold text-neutral-900 dark:text-neutral print:hidden sm:py-10"><nav class="flex items-start justify-between sm:items-center"><div class="flex flex-row items-center"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>/misczak</a></div><ul class="flex list-none flex-col ltr:text-right rtl:text-left sm:flex-row"><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/posts/ title=Posts>Blog</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/about/ title>About</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/categories/ title=Categories>Categories</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/posts/archive/ title=Archive>Archives</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/contact/ title>Contact</a></li></ul></nav></header><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header class=max-w-prose><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Tracking Temperature and Humidity at Home with Time Series Data</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2022-05-30 00:00:00 +0000 UTC">May 30 2022</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">10 mins</span></div></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first px-0 lg:order-last lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-10"><details open class="mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#acquiring-the-hardware>Acquiring the Hardware</a></li><li><a href=#booting-the-pi>Booting the Pi</a></li><li><a href=#creating-the-time-series-database>Creating the Time Series Database</a></li><li><a href=#scripting-data-collection>Scripting Data Collection</a></li><li><a href=#using-mongodb-charts-to-visualize-the-data>Using MongoDB Charts to Visualize the Data</a></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-prose grow"><p>Disclaimer: I am a MongoDB employee.</p><h2 id=background class="relative group">Background <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#background aria-label=Anchor>#</a></span></h2><p>Several years back, I received a Raspberry Pi 3 Model B+ kit from <a href=https://www.canakit.com/ target=_blank>CanaKit</a> alongside <a href=https://amzn.to/3wPWOMI target=_blank>this book</a>. I spent some time doing the basic stuff with it (blinking LEDs, running a Linux server, etc.) but eventually turning it into a <a href=https://retropie.org.uk/ target=_blank>RetroPie</a> and installing lots of retro games on it. After a while, I lost interest in tinkering with it and just let it collect dust in my office for a number of years.</p><p>I was recently cleaning out my office and rediscovered both the old RaspberryPi and the book, and was thumbing through the projects when I noticed one that caught my eye. Listed in the book as Project 12, it&rsquo;s a simple temperature and humidity data logger that didn&rsquo;t really draw my interest a few years ago. Since then, however, I&rsquo;ve moved to a new place where the bedrooms are essentially on the third floor (making them much warmer than the rest of the house). Because of this setup, one of the things that my wife and I constantly ask each other is how warm or cold it is in my son&rsquo;s nursery compared to the downstairs portions of the house. With this in mind, I decided to see if I could combine this simple Raspberry Pi project with the new <a href=https://www.mongodb.com/developer/products/mongodb/new-time-series-collections/ target=_blank>Time Series collections</a> that MongoDB offers starting with version 5.0. The idea was to make a tool that would display the current conditions of my son&rsquo;s nursery while also giving me the ability to show how the conditions changed throughout the day and look for patterns if I felt the need to do so.</p><h2 id=acquiring-the-hardware class="relative group">Acquiring the Hardware <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#acquiring-the-hardware aria-label=Anchor>#</a></span></h2><p>To build the temperature and humidity sensor, the book lists the following components:</p><ul><li>Raspberry Pi (obviously)</li><li>Breadboard</li><li>DHT22 temperature and humidity sensor (can substitute DHT11 or AM2302 as well)</li><li>4.7k ohm resistor</li><li>Jumper wires</li></ul><p>That&rsquo;s not an overwhelming number of components, but it&rsquo;s still a bunch of pieces that will make for a pretty messy package if you&rsquo;re trying to leave it somewhere in a discreet manner. You would have to connect GND on the Pi to the breadboard&rsquo;s blue rail, 3.3V on the Pi to the breadboard&rsquo;s red rail, and then connect the sensor to the breadboard and Pi as well, using the resistor on the 3.3V connection for DHT22 pin 2.</p><p>Instead, I found <a href=https://thepihut.com/products/dht22-temperature-humidity-sensor target=_blank>this DHT22 sensor</a> that comes with a handy 3-pin wire that you can plug directly into the Pi. DOUT goes to GPIO (pin 4) on the Pi, VCC goes to pin 1 on the Pi, and GND goes to pin 6 on the Pi. Using the case that came with my Pi from CanaKit, I was able to enclose the Pi and just had the wires escape out the top to the sensor, greatly cleaning up the overall appearance.</p><p><figure><img class="my-0 rounded-md" srcset="/posts/2022-05-30/images/rpi_hu7af45c05e7eaab656aeab8d5fe153c59_48491_330x0_resize_box_3.png 330w,
/posts/2022-05-30/images/rpi_hu7af45c05e7eaab656aeab8d5fe153c59_48491_660x0_resize_box_3.png 660w,
/posts/2022-05-30/images/rpi_hu7af45c05e7eaab656aeab8d5fe153c59_48491_1024x0_resize_box_3.png 1024w,
/posts/2022-05-30/images/rpi_hu7af45c05e7eaab656aeab8d5fe153c59_48491_1320x0_resize_box_3.png 2x" src=/posts/2022-05-30/images/rpi_hu7af45c05e7eaab656aeab8d5fe153c59_48491_660x0_resize_box_3.png alt="The enclosed Raspberry Pi and DHT22 sensor"></figure></p><h2 id=booting-the-pi class="relative group">Booting the Pi <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#booting-the-pi aria-label=Anchor>#</a></span></h2><p>This was by far the easiest part of this project. The <a href=https://www.raspberrypi.com/software/ target=_blank>Raspberry Pi OS</a> (formerly known as Raspbian) gives you an easy to use Linux OS. Better yet, the <a href="https://www.youtube.com/watch?v=ntaXWS8Lk34" target=_blank>Imager utility</a> helps you set up your install so it will work exactly the way you want right out of the box. You can setup a user for SSH so once it powers up, you can connect directly to it in a headless fashion. Once you have your Pi booted up and are able to SSH into it, the real work begins.</p><h2 id=creating-the-time-series-database class="relative group">Creating the Time Series Database <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#creating-the-time-series-database aria-label=Anchor>#</a></span></h2><p>We&rsquo;ll be using the Time Series collections feature of MongoDB 5.0. The easiest way to get started is to spin up a <a href=https://www.mongodb.com/docs/atlas/tutorial/deploy-free-tier-cluster/ target=_blank>free tier cluster on MongoDB Atlas</a> and then connect in with the new mongo shell, <a href=https://www.mongodb.com/docs/mongodb-shell/ target=_blank>mongosh</a>. You&rsquo;ll also want to make sure you create a database user with credentials that the script can use to connect to the database, as well as add an entry on the IP Access List to allow the connection in the first place.</p><p>Once connected to your cluster through <code>mongosh</code>, you&rsquo;ll want to create the time series collection as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>use ts
</span></span><span class=line><span class=cl>db.createCollection<span class=o>(</span><span class=s2>&#34;homeclimate&#34;</span>, <span class=o>{</span> 
</span></span><span class=line><span class=cl>    timeseries: <span class=o>{</span> 
</span></span><span class=line><span class=cl>        timeField: <span class=s2>&#34;timestamp&#34;</span>, 
</span></span><span class=line><span class=cl>        metaField: <span class=s2>&#34;metadata&#34;</span>, 
</span></span><span class=line><span class=cl>        granularity: <span class=s2>&#34;seconds&#34;</span> 
</span></span><span class=line><span class=cl>    <span class=o>}</span>, expireAfterSeconds: <span class=m>604800</span> 
</span></span><span class=line><span class=cl>    <span class=o>}</span> <span class=o>)</span>
</span></span></code></pre></div><p>The above command does the following:</p><ul><li>Creates a time series collection called &lsquo;homeclimate&rsquo; in the &rsquo;ts&rsquo; database</li><li>Establishes a granularity of seconds for document ingestion</li><li>Tells MongoDB that the &rsquo;timestamp&rsquo; field will be used to represent the time of each reading, and the &lsquo;metadata&rsquo; field will hold the information used to identify where the reading is coming from (such as what sensor)</li><li>Makes documents in this collection expire after 604800 seconds or a little over 7 days, as we don&rsquo;t want to pay for an ever increasing data size and any data older than that is probably of low analytical value</li></ul><h2 id=scripting-data-collection class="relative group">Scripting Data Collection <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#scripting-data-collection aria-label=Anchor>#</a></span></h2><p>The projects book linked to the <a href=https://github.com/adafruit/Adafruit_Python_DHT target=_blank>Adafruit Python DHT library</a> but if you go to the Github repo, you&rsquo;ll see that it&rsquo;s deprecated. The new version is <a href=https://github.com/adafruit/Adafruit_CircuitPython_DHT target=_blank>CircuitPython</a> which can be easily installed on the Raspberry Pi OS using pip:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pip3 install adafruit-circuitpython-dht
</span></span></code></pre></div><p>From there, it&rsquo;s time to actually start pulling data from the sensor with a continuously running script. Create a new Python script and edit it (I recommend using Visual Studio Code in Remote Mode to make this easier) to contain the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>board</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>adafruit_dht</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>datetime</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pymongo</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Initial the dht device, with data pin connected to:</span>
</span></span><span class=line><span class=cl><span class=n>dhtDevice</span> <span class=o>=</span> <span class=n>adafruit_dht</span><span class=o>.</span><span class=n>DHT22</span><span class=p>(</span><span class=n>board</span><span class=o>.</span><span class=n>D4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set up python client for MongoDB</span>
</span></span><span class=line><span class=cl><span class=n>client</span> <span class=o>=</span> <span class=n>pymongo</span><span class=o>.</span><span class=n>MongoClient</span><span class=p>(</span><span class=o>&lt;</span><span class=n>MONGODB</span> <span class=n>CONNECTION</span> <span class=n>STRING</span><span class=o>&gt;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>db</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>ts</span>
</span></span><span class=line><span class=cl><span class=n>collection</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>homeclimate</span>
</span></span><span class=line><span class=cl><span class=n>sensor</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># Pull the values right from the sensor device</span>
</span></span><span class=line><span class=cl>        <span class=n>temperature_c</span> <span class=o>=</span> <span class=n>dhtDevice</span><span class=o>.</span><span class=n>temperature</span>
</span></span><span class=line><span class=cl>        <span class=n>temperature_f</span> <span class=o>=</span> <span class=n>temperature_c</span> <span class=o>*</span> <span class=p>(</span><span class=mi>9</span> <span class=o>/</span> <span class=mi>5</span><span class=p>)</span> <span class=o>+</span> <span class=mi>32</span>
</span></span><span class=line><span class=cl>        <span class=n>humidity</span> <span class=o>=</span> <span class=n>dhtDevice</span><span class=o>.</span><span class=n>humidity</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Write a document with the temperature and humidity to the time series collection</span>
</span></span><span class=line><span class=cl>        <span class=n>document</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;metadata&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;sensorId&#34;</span><span class=p>:</span> <span class=n>sensor</span><span class=p>,</span> <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;climate&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;timestamp&#34;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;temperature_fahrenheit&#34;</span><span class=p>:</span> <span class=n>temperature_f</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;temperature_celsius&#34;</span><span class=p>:</span> <span class=n>temperature_c</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;humidity&#34;</span><span class=p>:</span> <span class=n>humidity</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>doc_id</span> <span class=o>=</span> <span class=n>collection</span><span class=o>.</span><span class=n>insert_one</span><span class=p>(</span><span class=n>document</span><span class=p>)</span><span class=o>.</span><span class=n>inserted_id</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Recorded reading to document </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>doc_id</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>RuntimeError</span> <span class=k>as</span> <span class=n>error</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># Errors will happen but need to keep going. Can make up for missed readings </span>
</span></span><span class=line><span class=cl>        <span class=c1># in the Time Series collection</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>error</span><span class=o>.</span><span class=n>args</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>2.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>continue</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>error</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>dhtDevice</span><span class=o>.</span><span class=n>exit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>error</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>10.0</span><span class=p>)</span>
</span></span></code></pre></div><p>There&rsquo;s a few things going on in this script:</p><ol><li>First, we&rsquo;re setting up the actual sensor by using the driver to build a device object and saying its connected on pin 4 (GPIO) on the Raspberry Pi.</li><li>We&rsquo;re creating a connection to our MongoDB cluster and specifying the database and collection we&rsquo;ll be storing data in. We also setup this sensor&rsquo;s identifier. Since this was my first sensor, I gave it a sensor ID of 1. Future sensors will increment this value.</li><li>In a infinite while loop, we grab the temperature and humidity values from the sensor. Since I live in the US, I also convert this temperature to farenheit and put both temperature values alongside with humidity into a MongoDB document. Since we&rsquo;re using a Time Series collection, I have an embedded document with my metadata values - a sensorID and a sensor type that may come in handy in the future as I scale these out. The only other value in the document is the current UTC timestamp, which is critical for helping build the time series view.</li><li>After taking the reading and writing it to the database, we wait ten seconds until we do it again. This time can be adjusted up or down depending on how granular you want your time series data to be.</li></ol><p>If you&rsquo;ve configured your MongoDB connection string correctly and added the entry in the IP Access List in Atlas, running this script should start writing to your Time Series collection. You should see the results after just a few seconds by going to the Collections view in Atlas:</p><p><figure><img class="my-0 rounded-md" srcset="/posts/2022-05-30/images/tscollectionview_hue040b019e1e503aed91c4152470132eb_96516_330x0_resize_box_3.png 330w,
/posts/2022-05-30/images/tscollectionview_hue040b019e1e503aed91c4152470132eb_96516_660x0_resize_box_3.png 660w,
/posts/2022-05-30/images/tscollectionview_hue040b019e1e503aed91c4152470132eb_96516_1024x0_resize_box_3.png 1024w,
/posts/2022-05-30/images/tscollectionview_hue040b019e1e503aed91c4152470132eb_96516_1320x0_resize_box_3.png 2x" src=/posts/2022-05-30/images/tscollectionview_hue040b019e1e503aed91c4152470132eb_96516_660x0_resize_box_3.png alt="Documents populating the time series collection"></figure></p><h2 id=using-mongodb-charts-to-visualize-the-data class="relative group">Using MongoDB Charts to Visualize the Data <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#using-mongodb-charts-to-visualize-the-data aria-label=Anchor>#</a></span></h2><p>Now that the readings are coming into MongoDB, you can use the Charts feature of MongoDB Atlas to create a dashboard and display useful information and visualizations derived from the raw data. Start by clicking on the <strong>Charts</strong> tab at the top of MongoDB Atlas, then select <strong>Data Sources</strong> in the left hand menu. On that page, click the <strong>Add Data Source</strong> button in the upper right and then select your cluster. It should only have one database - <code>ts</code> - and one collection - <code>homeclimate</code>. Select those and click <strong>Finish</strong> to set up the data source.</p><p><figure><img class="my-0 rounded-md" srcset="/posts/2022-05-30/images/chartsdatasource_hub0600aad59446d86b9646ecbd76f26bb_77681_330x0_resize_box_3.png 330w,
/posts/2022-05-30/images/chartsdatasource_hub0600aad59446d86b9646ecbd76f26bb_77681_660x0_resize_box_3.png 660w,
/posts/2022-05-30/images/chartsdatasource_hub0600aad59446d86b9646ecbd76f26bb_77681_1024x0_resize_box_3.png 1024w,
/posts/2022-05-30/images/chartsdatasource_hub0600aad59446d86b9646ecbd76f26bb_77681_1320x0_resize_box_3.png 2x" src=/posts/2022-05-30/images/chartsdatasource_hub0600aad59446d86b9646ecbd76f26bb_77681_660x0_resize_box_3.png alt="Using the time series collection as a Charts data source"></figure></p><p>Now that the time series collection shows up in the Data Sources list, look to the <em>Pipeline</em> column near the right hand side. Click the <strong>Add Pipeline</strong> button. We&rsquo;re going to use the <a href=https://www.mongodb.com/docs/manual/reference/operator/aggregation/setWindowFields/ target=_blank>$setWindowFields</a> aggregation operator to build a window function on the time series collection; specifically, we&rsquo;re going to run a calculation on only the readings from the last hour.</p><p>Inside the Aggregation Pipeline Edit modal that appears, paste in the following pipeline:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=nx>$setWindowFields</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>partitionBy</span><span class=o>:</span> <span class=s2>&#34;$metadata.sensorId&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>sortBy</span><span class=o>:</span> <span class=p>{</span> <span class=nx>timestamp</span><span class=o>:</span> <span class=mi>1</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>output</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>lastHourAverageTemp</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>$avg</span><span class=o>:</span> <span class=s2>&#34;$temperature_fahrenheit&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nb>window</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>documents</span><span class=o>:</span> <span class=p>[</span><span class=o>-</span><span class=mi>360</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nx>lastHourAverageHumidity</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>$avg</span><span class=o>:</span> <span class=s2>&#34;$humidity&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nb>window</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>documents</span><span class=o>:</span> <span class=p>[</span><span class=o>-</span><span class=mi>360</span><span class=p>,</span> <span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=p>]</span>
</span></span></code></pre></div><p>This window function creates two new fields for us to use in MongoDB Charts - the <code>lastHourAverageTemp</code> and <code>lastHourAverageHumidity</code>. Note that I used the original Fahrenheit temperature as the source for this new average temperature field - depending on where you&rsquo;re located, you may want to swap in Celsius instead. Since we&rsquo;re collecting readings every 10 seconds in our original script, we go back 360 readings (6 readings a minute multipled by 60 minutes in an hour). Click <strong>Save</strong> when you&rsquo;ve pasted this in.</p><p>Now click on <strong>Dashboards</strong> on the left hand navigation, then select the <strong>Add Dashboard</strong> button on the far right. Call the dashboard whatever you want. Once it&rsquo;s open, we&rsquo;ll have to add some charts. Click on Add Chart and you&rsquo;ll be brought to the MongoDB Charts editor. If you&rsquo;ve never used it before, I recommend checking out the <a href=https://www.mongodb.com/docs/charts/ target=_blank>Charts documentation</a> to check out all the features it has.</p><p>For now, we&rsquo;re going to add a simple chart to display the current temperature. In the upper left under data source, select <strong>ts.homeclimate</strong> which should be the only option available. Choose <strong>Text</strong> as the <em>Chart Type</em>, then select <strong>Top Item</strong> as want the most recent temperature reading. Now drag &rsquo;timestamp&rsquo; to the <em>Sort</em> field placeholder, and click the sort button to the right of it to make sure it&rsquo;s in descending order. Drag <code>temperature_fahrenheit</code> to the <em>Display</em> field placeholder and you should now get the most recent reading&rsquo;s Fahrenheit temperature value. Click <strong>Save and Close</strong> at the top.</p><p><figure><img class="my-0 rounded-md" srcset="/posts/2022-05-30/images/currenttemp_hube16323c1452d76a80fc112989a0717d_82334_330x0_resize_box_3.png 330w,
/posts/2022-05-30/images/currenttemp_hube16323c1452d76a80fc112989a0717d_82334_660x0_resize_box_3.png 660w,
/posts/2022-05-30/images/currenttemp_hube16323c1452d76a80fc112989a0717d_82334_1024x0_resize_box_3.png 1024w,
/posts/2022-05-30/images/currenttemp_hube16323c1452d76a80fc112989a0717d_82334_1320x0_resize_box_3.png 2x" src=/posts/2022-05-30/images/currenttemp_hube16323c1452d76a80fc112989a0717d_82334_660x0_resize_box_3.png alt="The Current Temperature Chart Configuration"></figure></p><p>Now we can add another chart and do the same exact thing, but instead of the regular &rsquo;temperature_fahrenheit&rsquo; field being used as the reading, we can use the &rsquo;lastHourAverageTemp&rsquo; field that was added via the pipeline we attached to the data source. This will give us a view of the average temperature of the last hour in case the most recent temperature becomes an outlier, like if someone opens a window or starts running a heater.</p><p><figure><img class="my-0 rounded-md" srcset="/posts/2022-05-30/images/averagetemp_hub28b0be1099ce9463f59a7a792c1b4b4_98946_330x0_resize_box_3.png 330w,
/posts/2022-05-30/images/averagetemp_hub28b0be1099ce9463f59a7a792c1b4b4_98946_660x0_resize_box_3.png 660w,
/posts/2022-05-30/images/averagetemp_hub28b0be1099ce9463f59a7a792c1b4b4_98946_1024x0_resize_box_3.png 1024w,
/posts/2022-05-30/images/averagetemp_hub28b0be1099ce9463f59a7a792c1b4b4_98946_1320x0_resize_box_3.png 2x" src=/posts/2022-05-30/images/averagetemp_hub28b0be1099ce9463f59a7a792c1b4b4_98946_660x0_resize_box_3.png alt="The Last Hour Average Temperature Chart Configuration"></figure></p><p>Then we can add a third chart to visualize the change in temperature over time from the sensor. Add a new chart and this time, for <em>Chart Type</em> select <strong>Line</strong>. In the Encode tab, for the <em>X-Axis</em> select <code>timestamp</code> and turn on Binning, selecting <em>Hour</em> from the dropdown. For the <em>Y-Axis</em> select <code>temperature_fahrenheit</code>, and under the Aggregate dropdown select <em>Mean</em>. The combination of these two settings will combine all of an hour&rsquo;s readings into one group and take the average to represent that hour on the line chart. Finally, under <em>Series</em> we can select <code>sensorId</code> under <code>metadata</code>. While we only have one sensor currently, if we add more sensors in the future, this will show different lines for each sensor.</p><p>Now on the Filter tab, drag <code>timestamp</code> in as the filter and select <em>Period</em>, <em>Previous</em>, and <em>3 Day</em> to limit the chart to only consider the previous three days worth of data. Again, you can adjust this period up or down to suit your needs.</p><p><figure><img class="my-0 rounded-md" srcset="/posts/2022-05-30/images/changeintemp_hucce97fec6045ded5405ee9fdca2cec57_122654_330x0_resize_box_3.png 330w,
/posts/2022-05-30/images/changeintemp_hucce97fec6045ded5405ee9fdca2cec57_122654_660x0_resize_box_3.png 660w,
/posts/2022-05-30/images/changeintemp_hucce97fec6045ded5405ee9fdca2cec57_122654_1024x0_resize_box_3.png 1024w,
/posts/2022-05-30/images/changeintemp_hucce97fec6045ded5405ee9fdca2cec57_122654_1320x0_resize_box_3.png 2x" src=/posts/2022-05-30/images/changeintemp_hucce97fec6045ded5405ee9fdca2cec57_122654_660x0_resize_box_3.png alt="Visualization of the Hourly Change in Temperature"></figure></p><p>If you save and close, you&rsquo;ll have a nice dashboard of three charts showing you some basic temperature inforamtion from your sensor. As your sensor continues writing data, the line chart will become more useful as well. You can repeat this process to create three charts with the humidity data as well to give you a full representation of readings from the sensor.</p><p><figure><img class="my-0 rounded-md" srcset="/posts/2022-05-30/images/completedashboard_hu8660fe5744e725246a82aaa3cd5bd510_135242_330x0_resize_box_3.png 330w,
/posts/2022-05-30/images/completedashboard_hu8660fe5744e725246a82aaa3cd5bd510_135242_660x0_resize_box_3.png 660w,
/posts/2022-05-30/images/completedashboard_hu8660fe5744e725246a82aaa3cd5bd510_135242_1024x0_resize_box_3.png 1024w,
/posts/2022-05-30/images/completedashboard_hu8660fe5744e725246a82aaa3cd5bd510_135242_1320x0_resize_box_3.png 2x" src=/posts/2022-05-30/images/completedashboard_hu8660fe5744e725246a82aaa3cd5bd510_135242_660x0_resize_box_3.png alt="The Complete Dashboard of Temperature and Humidity Data"></figure></p></div></section><footer class="pt-8 max-w-prose print:hidden"><div class=flex><img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width=96 height=96 alt="John Misczak" src=/img/author_hub50b6b8a906c93a65ba8a4369efaedb9_111822_192x192_fill_q75_box_smart1.jpg><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">John Misczak</div><div class="text-sm text-neutral-700 dark:text-neutral-400">Security Engineer</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/misczak target=_blank aria-label=Github rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" href=https://linkedin.com/in/johnmisczak target=_blank aria-label=Linkedin rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg></span></a><a class="px-1 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" href=https://infosec.exchange/@misczak target=_blank aria-label=Mastodon rel="me noopener noreferrer"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg></span></a></div></div></div></div><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="group flex" href=/posts/2022-03-20/><span class="mr-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-2 text-neutral-700 transition-transform group-hover:translate-x-[2px] group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Building Event Driven Experiences with MongoDB Realm and AWS</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2022-03-20 00:00:00 +0000 UTC">March 20 2022</time></span></span></a></span>
<span><a class="group flex text-right" href=/posts/2022-08-16/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">MongoDB World 2022 Talk: Look Ma, No Public IP!</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2022-08-16 00:00:00 +0000 UTC">August 16 2022</time></span></span>
<span class="ml-2 text-neutral-700 transition-transform group-hover:translate-x-[2px] group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div></footer></article><div class="pointer-events-none absolute top-[100vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2023
John Misczak</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://git.io/hugo-congo target=_blank rel="noopener noreferrer">Congo</a></p></div></div></footer></div></body></html>